name: Arduino Build

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v1
    
    - name: Cache Arduino ESP32 platform
      uses: actions/cache@v4
      with:
        path: |
          ~/.arduino15/packages/esp32
          ~/.arduino15/staging/packages
        key: ${{ runner.os }}-arduino-esp32-${{ hashFiles('**/build.yml') }}
        restore-keys: |
          ${{ runner.os }}-arduino-esp32-
      
    - name: Install ESP32 platform
      run: |
        arduino-cli core update-index
        arduino-cli core install esp32:esp32
    
    - name: Cache Arduino libraries
      uses: actions/cache@v4
      with:
        path: |
          ~/Arduino/libraries
        key: ${{ runner.os }}-arduino-libs-${{ hashFiles('**/build.yml') }}
        restore-keys: |
          ${{ runner.os }}-arduino-libs-
        
    - name: Install required libraries
      run: |
        arduino-cli lib install "M5Unified"
        wget https://github.com/T-vK/ESP32-BLE-Keyboard/releases/download/0.3.0/ESP32-BLE-Keyboard.zip
        unzip ESP32-BLE-Keyboard.zip -d ~/Arduino/libraries/
        
    - name: Apply BLE Keyboard patch
      run: |
        cd ~/Arduino/libraries/ESP32-BLE-Keyboard
        patch -p1 < $GITHUB_WORKSPACE/patches/BleKeyboard.patch
        
    - name: Compile sketch
      run: |
        arduino-cli compile --fqbn esp32:esp32:m5stack_atoms3 --output-dir ./build single-button-page-turner.ino
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: single-button-page-turner-firmware
        path: |
          build/*.bin
          build/*.elf
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/single-button-page-turner.ino.bin
          build/single-button-page-turner.ino.bootloader.bin
          build/single-button-page-turner.ino.partitions.bin
        body: |
          ## Single Button Page Turner (SBPT) Firmware Release
          
          ### Installation Instructions
          
          #### Using esptool.py:
          ```bash
          pip install esptool
          esptool.py --chip esp32s3 --port /dev/ttyUSB0 --baud 921600 write_flash -z \
            0x0 single-button-page-turner.ino.bootloader.bin \
            0x8000 single-button-page-turner.ino.partitions.bin \
            0x10000 single-button-page-turner.ino.bin
          ```
          
          #### Using ESP Flash Download Tool:
          1. Download [Flash Download Tool](https://www.espressif.com/en/support/download/other-tools)
          2. Load the three .bin files at the addresses shown above
          3. Click "Start" to flash
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
